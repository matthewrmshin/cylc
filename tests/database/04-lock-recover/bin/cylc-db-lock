#!/usr/bin/env python3
"""Lock a suite's database file."""

from fcntl import lockf, LOCK_SH
import os
from subprocess import call

def main():
    run_d = os.getenv("CYLC_SUITE_RUN_DIR")
    handle = open(os.path.join(run_d, "log", "db"))
    lockf(handle, LOCK_SH)
    call([
        "cylc", "task", "message", "I have locked the public database file"])
    while True:
        for line in open(os.path.join(run_d, "log", "suite", "log")):
            if "write attempt (1) did not complete" in line:
                return

if __name__ == "__main__":
    main()
